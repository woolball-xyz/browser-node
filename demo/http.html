<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Tasks Demo</title>
  <script>
    // Script global para capturar erros, inclusive de workers e operações assíncronas
    window.addEventListener('error', function(event) {
      console.error('[GLOBAL ERROR]', event.error || event.message);
      // Opcional: mostrar em algum elemento visual
      const errorBanner = document.createElement('div');
      errorBanner.style.position = 'fixed';
      errorBanner.style.top = '0';
      errorBanner.style.left = '0';
      errorBanner.style.right = '0';
      errorBanner.style.backgroundColor = '#ff4d4d';
      errorBanner.style.color = 'white';
      errorBanner.style.padding = '8px';
      errorBanner.style.zIndex = '9999';
      errorBanner.style.textAlign = 'center';
      errorBanner.innerText = event.error ? event.error.message : event.message;
      document.body.appendChild(errorBanner);
      setTimeout(() => errorBanner.remove(), 5000);
    });

    // Redireciona logs do console para também exibir visualmente
    const originalConsoleError = console.error;
    console.error = function(...args) {
      originalConsoleError.apply(console, args);
      
      // Criar ou atualizar área de logs
      let logArea = document.getElementById('console-log-area');
      if (!logArea) {
        logArea = document.createElement('div');
        logArea.id = 'console-log-area';
        logArea.style.position = 'fixed';
        logArea.style.bottom = '0';
        logArea.style.right = '0';
        logArea.style.width = '400px';
        logArea.style.maxHeight = '200px';
        logArea.style.backgroundColor = 'rgba(0,0,0,0.8)';
        logArea.style.color = 'white';
        logArea.style.padding = '10px';
        logArea.style.fontFamily = 'monospace';
        logArea.style.fontSize = '12px';
        logArea.style.overflowY = 'auto';
        logArea.style.zIndex = '9998';
        document.body.appendChild(logArea);
      }
      
      const logEntry = document.createElement('div');
      logEntry.style.borderBottom = '1px solid #333';
      logEntry.style.padding = '3px 0';
      logEntry.style.color = '#ff6666';
      logEntry.textContent = args.map(arg => 
        typeof arg === 'object' ? JSON.stringify(arg) : String(arg)
      ).join(' ');
      
      logArea.appendChild(logEntry);
      logArea.scrollTop = logArea.scrollHeight;
      
      // Limita o número de entradas
      while (logArea.childNodes.length > 20) {
        logArea.removeChild(logArea.firstChild);
      }
    };
  </script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    .card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .result {
      white-space: pre-wrap;
      background-color: #f5f5f5;
      padding: 10px;
      border-radius: 4px;
      max-height: 300px;
      overflow-y: auto;
    }
    .status {
      color: #666;
      margin-top: 10px;
    }
    button {
      padding: 10px 20px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 10px;
    }
    button:disabled {
      background-color: #ccc;
    }
    .checkbox-group, .input-group {
      margin: 10px 0;
    }
    .input-group label {
      display: block;
      margin-bottom: 5px;
    }
    .input-group input, .input-group textarea, .input-group select {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .tabs {
      display: flex;
      border-bottom: 1px solid #ddd;
      margin-bottom: 20px;
    }
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      background-color: #f1f1f1;
      margin-right: 5px;
      border-radius: 5px 5px 0 0;
    }
    .tab.active {
      background-color: #007bff;
      color: white;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .audio-player {
      width: 100%;
      margin-top: 10px;
    }
    textarea {
      min-height: 100px;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <h1>AI Tasks Demo</h1>
  
  <div class="tabs">
    <div class="tab active" data-tab="asr">Speech Recognition</div>
    <div class="tab" data-tab="tts">Text to Speech</div>
    <div class="tab" data-tab="translation">Translation</div>
    <div class="tab" data-tab="text-generation">Text Generation</div>
  </div>
  
  <div class="tab-content active" id="asr-content">
    <div class="card">
      <h2>Audio to Text</h2>
      <input type="file" id="audioFile" accept="audio/*">
      <div class="input-group">
        <label for="asrModelInput">Model</label>
        <input type="text" id="asrModelInput" value="onnx-community/whisper-large-v3-turbo_timestamped">
        
        <label for="asrDtypeInput">Dtype</label>
        <input type="text" id="asrDtypeInput" value="q4">
        
        <label for="asrLanguageInput">Language</label>
        <input type="text" id="asrLanguageInput" value="en">
      </div>
      <div class="checkbox-group">
        <label>
          <input type="checkbox" id="timestampCheckbox">
          Include timestamps
        </label>
        <label>
          <input type="checkbox" id="streamCheckbox">
          Enable streaming
        </label>
      </div>
      <button id="asrBtn" disabled>Convert to Text</button>
      <p class="status" id="asrStatus">Select an audio file to start.</p>
    </div>
  </div>

  <div class="tab-content" id="tts-content">
    <div class="card">
      <h2>Text to Speech</h2>
      <div class="input-group">
        <label for="ttsInput">Text</label>
        <textarea id="ttsInput" placeholder="Enter text to convert to speech"></textarea>
        
        <label for="ttsModelInput">Model</label>
        <select id="ttsModelInput">
          <optgroup label="Language-specific Models">
            <option value="Xenova/mms-tts-eng">English (eng)</option>
            <option value="Xenova/mms-tts-spa">Spanish (spa)</option>
            <option value="Xenova/mms-tts-por">Portuguese (por)</option>
            <option value="Xenova/mms-tts-fra">French (fra)</option>
            <option value="Xenova/mms-tts-deu">German (deu)</option>
            <option value="Xenova/mms-tts-rus">Russian (rus)</option>
            <option value="Xenova/mms-tts-ara">Arabic (ara)</option>
            <option value="Xenova/mms-tts-hin">Hindi (hin)</option>
            <option value="Xenova/mms-tts-kor">Korean (kor)</option>
            <option value="Xenova/mms-tts-vie">Vietnamese (vie)</option>
            <option value="Xenova/mms-tts-ron">Romanian (ron)</option>
            <option value="Xenova/mms-tts-yor">Yoruba (yor)</option>
          </optgroup>
          <optgroup label="Other Engines">
            <option value="onnx-community/Kokoro-82M-ONNX">Kokoro TTS</option>
          </optgroup>
        </select>
        
        <label for="ttsDtypeInput">Dtype</label>
        <input type="text" id="ttsDtypeInput" value="q8">
        
        <div id="kokoroVoiceContainer" class="hidden">
          <label for="ttsVoiceInput">Voice (Kokoro voices)</label>
          <select id="ttsVoiceInput">
            <option value="af_heart">Heart (American Female)</option>
            <option value="af_alloy">Alloy (American Female)</option>
            <option value="af_aoede">Aoede (American Female)</option>
            <option value="af_bella">Bella (American Female)</option>
            <option value="af_jessica">Jessica (American Female)</option>
            <option value="af_kore">Kore (American Female)</option>
            <option value="af_nicole">Nicole (American Female)</option>
            <option value="af_nova">Nova (American Female)</option>
            <option value="af_river">River (American Female)</option>
            <option value="af_sarah">Sarah (American Female)</option>
            <option value="af_sky">Sky (American Female)</option>
            <option value="am_adam">Adam (American Male)</option>
            <option value="am_echo">Echo (American Male)</option>
            <option value="am_eric">Eric (American Male)</option>
            <option value="am_fenrir">Fenrir (American Male)</option>
            <option value="am_liam">Liam (American Male)</option>
            <option value="am_michael">Michael (American Male)</option>
            <option value="am_onyx">Onyx (American Male)</option>
            <option value="am_puck">Puck (American Male)</option>
            <option value="am_santa">Santa (American Male)</option>
            <option value="bf_emma">Emma (British Female)</option>
            <option value="bf_isabella">Isabella (British Female)</option>
            <option value="bf_alice">Alice (British Female)</option>
            <option value="bf_lily">Lily (British Female)</option>
            <option value="bm_george">George (British Male)</option>
            <option value="bm_lewis">Lewis (British Male)</option>
            <option value="bm_daniel">Daniel (British Male)</option>
            <option value="bm_fable">Fable (British Male)</option>
          </select>
        </div>
      </div>
      <button id="ttsBtn">Generate Speech</button>
      <p class="status" id="ttsStatus">Enter text to generate speech.</p>
      <audio id="ttsAudio" controls class="audio-player" style="display: none;"></audio>
    </div>
  </div>

  <div class="tab-content" id="translation-content">
    <div class="card">
      <h2>Translation</h2>
      <div class="input-group">
        <label for="translationInput">Text to Translate</label>
        <textarea id="translationInput" placeholder="Enter text to translate"></textarea>
        
        <label for="translationModelInput">Model</label>
        <input type="text" id="translationModelInput" value="Xenova/nllb-200-distilled-600M">
        
        <label for="translationDtypeInput">Dtype</label>
        <input type="text" id="translationDtypeInput" value="q8">
        
        <label for="source_lang">Source Language</label>
        <input type="text" id="source_lang" value="eng_Latn">
        
        <label for="tgtLangInput">Target Language</label>
        <input type="text" id="tgtLangInput" value="por_Latn">
      </div>
      <button id="translationBtn">Translate</button>
      <p class="status" id="translationStatus">Enter text to translate.</p>
    </div>
  </div>

  <div class="tab-content" id="text-generation-content">
    <div class="card">
      <h2>Text Generation</h2>
      <div class="input-group">
        <label for="systemPromptInput">System Prompt</label>
        <textarea id="systemPromptInput">You are a helpful assistant.</textarea>
        
        <label for="userPromptInput">User Prompt</label>
        <textarea id="userPromptInput" placeholder="Enter your prompt">What is the capital of the Brazil?</textarea>
        
        <label for="textGenModelInput">Model</label>
        <input type="text" id="textGenModelInput" value="HuggingFaceTB/SmolLM2-135M-Instruct">
        
        <label for="textGenDtypeInput">Dtype</label>
        <input type="text" id="textGenDtypeInput" value="fp16">
        
        <label for="maxTokensInput">Max Tokens</label>
        <input type="number" id="maxTokensInput" value="250">
        
        <label>
          <input type="checkbox" id="doSampleCheckbox">
          Do Sample
        </label>
      </div>
      <button id="textGenBtn">Generate</button>
      <p class="status" id="textGenStatus">Enter a prompt to generate text.</p>
    </div>
  </div>
  
  <div class="card">
    <h2>Result</h2>
    <div class="result" id="result">Results will appear here.</div>
  </div>

  <script type="module">
    import { HttpClient } from './http-client.js';

    const API_URL = 'http://localhost:9002';
    const httpClient = new HttpClient(API_URL);
    
    // Tab functionality
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');
    
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        // Remove active class from all tabs and contents
        tabs.forEach(t => t.classList.remove('active'));
        tabContents.forEach(c => c.classList.remove('active'));
        
        // Add active class to clicked tab and corresponding content
        tab.classList.add('active');
        const tabId = tab.getAttribute('data-tab');
        document.getElementById(`${tabId}-content`).classList.add('active');
      });
    });
    
    // ASR (Speech Recognition)
    const audioFileInput = document.getElementById('audioFile');
    const asrBtn = document.getElementById('asrBtn');
    const asrStatus = document.getElementById('asrStatus');
    const asrModelInput = document.getElementById('asrModelInput');
    const asrDtypeInput = document.getElementById('asrDtypeInput');
    const asrLanguageInput = document.getElementById('asrLanguageInput');
    const timestampCheckbox = document.getElementById('timestampCheckbox');
    const streamCheckbox = document.getElementById('streamCheckbox');
    
    audioFileInput.addEventListener('change', function() {
      asrBtn.disabled = !this.files.length;
      if (this.files.length) {
        asrStatus.textContent = `File selected: ${this.files[0].name}`;
      } else {
        asrStatus.textContent = 'Select an audio file to start.';
      }
    });
    
    asrBtn.addEventListener('click', async function() {
      if (!audioFileInput.files.length) return;
      
      try {
        const file = audioFileInput.files[0];
        asrBtn.disabled = true;
        asrStatus.textContent = 'Processing audio...';
        document.getElementById('result').textContent = 'Processing...';

        const response = await httpClient.processAudio(file, {
          timestamps: timestampCheckbox.checked,
          stream: streamCheckbox.checked,
          language: asrLanguageInput.value,
          model: asrModelInput.value,
          dtype: asrDtypeInput.value
        });

        if (streamCheckbox.checked) {
          asrStatus.textContent = 'Streaming results...';
          document.getElementById('result').textContent = '';

          await httpClient.handleStreamResponse(response, (chunk) => {
            document.getElementById('result').textContent += chunk;
          });

          asrStatus.textContent = 'Conversion completed!';
        } else {
          const results = await response.json();
          asrStatus.textContent = 'Success!';
          document.getElementById('result').textContent = JSON.stringify(results, null, 2);
        }
      } catch (error) {
        asrStatus.textContent = `Error: ${error.message}`;
        console.error('Error processing audio:', error);
      } finally {
        asrBtn.disabled = false;
      }
    });
    
    // TTS (Text to Speech)
    const ttsInput = document.getElementById('ttsInput');
    const ttsBtn = document.getElementById('ttsBtn');
    const ttsStatus = document.getElementById('ttsStatus');
    const ttsModelInput = document.getElementById('ttsModelInput');
    const ttsDtypeInput = document.getElementById('ttsDtypeInput');
    const ttsVoiceInput = document.getElementById('ttsVoiceInput');
    const ttsAudio = document.getElementById('ttsAudio');
    const kokoroVoiceContainer = document.getElementById('kokoroVoiceContainer');
    
    // Show/hide voice options based on model selection
    ttsModelInput.addEventListener('change', function() {
      if (this.value === 'onnx-community/Kokoro-82M-ONNX') {
        kokoroVoiceContainer.classList.remove('hidden');
      } else {
        kokoroVoiceContainer.classList.add('hidden');
      }
    });
    
    ttsBtn.addEventListener('click', async function() {
      if (!ttsInput.value.trim()) {
        ttsStatus.textContent = 'Please enter text to convert to speech.';
        return;
      }
      
      try {
        ttsBtn.disabled = true;
        ttsStatus.textContent = 'Generating speech...';
        document.getElementById('result').textContent = 'Processing...';
        ttsAudio.style.display = 'none';

        // Only include voice parameter if Kokoro is selected
        const isKokoro = ttsModelInput.value === 'onnx-community/Kokoro-82M-ONNX';
        
        const response = await httpClient.processTextToSpeech(ttsInput.value, {
          model: ttsModelInput.value,
          dtype: ttsDtypeInput.value,
          voice: isKokoro ? ttsVoiceInput.value : undefined
        });

        const result = await response.json();
        ttsStatus.textContent = 'Success!';
        
        if (result.audio) {
          // Display info in result area
          document.getElementById('result').textContent = 'Audio generated successfully!';
          
          try {
            console.log('Recebido áudio base64, processando...');
            // Usar nosso novo método para processar o áudio
            const audioData = httpClient.createAudioFromBase64(result.audio);
            
            // Definir a fonte do elemento de áudio
            ttsAudio.src = audioData.url;
            ttsAudio.style.display = 'block';
            
            // Adicionar detalhes ao resultado para depuração
            const audioInfoDiv = document.createElement('div');
            audioInfoDiv.classList.add('audio-info');
            audioInfoDiv.innerHTML = `
              <h3>Informações do áudio</h3>
              <ul>
                <li>Tipo MIME: ${audioData.mimeType}</li>
                <li>Tamanho do blob: ${(audioData.blob.size / 1024).toFixed(2)} KB</li>
                <li>Duração: <span id="audioDuration">carregando...</span></li>
              </ul>
              <details>
                <summary>Base64 Preview (primeiros 50 caracteres)</summary>
                <pre>${result.audio.substring(0, 50)}...</pre>
              </details>
            `;
            
            // Substituir o texto antigo
            const resultDiv = document.getElementById('result');
            resultDiv.textContent = '';
            resultDiv.appendChild(audioInfoDiv);
            
            // Mostrar a duração do áudio quando carregar
            ttsAudio.onloadedmetadata = function() {
              document.getElementById('audioDuration').textContent = `${ttsAudio.duration.toFixed(2)} segundos`;
            };
            
            // Manipular erro de carregamento
            ttsAudio.onerror = function() {
              console.error('Erro ao carregar áudio:', ttsAudio.error);
              document.getElementById('result').textContent = `Erro ao carregar áudio: ${ttsAudio.error?.message || 'Erro desconhecido'}`;
            };
          } catch (audioError) {
            console.error('Erro ao processar o áudio base64:', audioError);
            document.getElementById('result').textContent = `Erro ao processar áudio: ${audioError.message}`;
            
            // Exibir os primeiros caracteres do base64 para ajudar na depuração
            if (result.audio) {
              const errorDetails = document.createElement('details');
              errorDetails.innerHTML = `
                <summary>Detalhes do erro</summary>
                <p>Erro: ${audioError.message}</p>
                <p>Base64 recebido (primeiros 50 caracteres):</p>
                <pre>${result.audio.substring(0, 50)}...</pre>
              `;
              document.getElementById('result').appendChild(errorDetails);
            }
          }
        } else if (result.error) {
          document.getElementById('result').textContent = `Error: ${result.error}`;
        }
      } catch (error) {
        ttsStatus.textContent = `Error: ${error.message}`;
        document.getElementById('result').textContent = `Error: ${error.message}`;
        console.error('Error generating speech:', error);
      } finally {
        ttsBtn.disabled = false;
      }
    });
    
    // Initialize visibility of voice options
    if (ttsModelInput.value === 'onnx-community/Kokoro-82M-ONNX') {
      kokoroVoiceContainer.classList.remove('hidden');
    }
    
    // Translation
    const translationInput = document.getElementById('translationInput');
    const translationBtn = document.getElementById('translationBtn');
    const translationStatus = document.getElementById('translationStatus');
    const translationModelInput = document.getElementById('translationModelInput');
    const translationDtypeInput = document.getElementById('translationDtypeInput');
    const source_lang = document.getElementById('source_lang');
    const tgtLangInput = document.getElementById('tgtLangInput');
    
    translationBtn.addEventListener('click', async function() {
      if (!translationInput.value.trim()) {
        translationStatus.textContent = 'Please enter text to translate.';
        return;
      }
      
      try {
        translationBtn.disabled = true;
        translationStatus.textContent = 'Translating...';
        document.getElementById('result').textContent = 'Processing...';

        const response = await httpClient.processTranslation(translationInput.value, {
          model: translationModelInput.value,
          dtype: translationDtypeInput.value,
          srcLang: source_lang.value,
          tgtLang: tgtLangInput.value
        });

        const result = await response.json();
        translationStatus.textContent = 'Success!';
        
        if (result.translatedText) {
          document.getElementById('result').textContent = result.translatedText;
        } else if (result.error) {
          document.getElementById('result').textContent = `Error: ${result.error}`;
        }
      } catch (error) {
        translationStatus.textContent = `Error: ${error.message}`;
        document.getElementById('result').textContent = `Error: ${error.message}`;
        console.error('Error translating text:', error);
      } finally {
        translationBtn.disabled = false;
      }
    });
    
    // Text Generation
    const systemPromptInput = document.getElementById('systemPromptInput');
    const userPromptInput = document.getElementById('userPromptInput');
    const textGenBtn = document.getElementById('textGenBtn');
    const textGenStatus = document.getElementById('textGenStatus');
    const textGenModelInput = document.getElementById('textGenModelInput');
    const textGenDtypeInput = document.getElementById('textGenDtypeInput');
    const maxTokensInput = document.getElementById('maxTokensInput');
    const doSampleCheckbox = document.getElementById('doSampleCheckbox');
    
    textGenBtn.addEventListener('click', async function() {
      if (!userPromptInput.value.trim()) {
        textGenStatus.textContent = 'Please enter a prompt.';
        return;
      }
      
      try {
        textGenBtn.disabled = true;
        textGenStatus.textContent = 'Generating text...';
        document.getElementById('result').textContent = 'Processing...';

        // Create message array
        const messages = [
          { role: "system", content: systemPromptInput.value },
          { role: "user", content: userPromptInput.value }
        ];

        const response = await httpClient.processTextGeneration(messages, {
          model: textGenModelInput.value,
          dtype: textGenDtypeInput.value,
          max_new_tokens: parseInt(maxTokensInput.value),
          do_sample: doSampleCheckbox.checked
        });

        const result = await response.json();
        textGenStatus.textContent = 'Success!';
        
        if (result.generatedText) {
          document.getElementById('result').textContent = result.generatedText;
        } else if (result.error) {
          document.getElementById('result').textContent = `Error: ${result.error}`;
        }
      } catch (error) {
        textGenStatus.textContent = `Error: ${error.message}`;
        document.getElementById('result').textContent = `Error: ${error.message}`;
        console.error('Error generating text:', error);
      } finally {
        textGenBtn.disabled = false;
      }
    });

    // Load the default audio file
    async function loadDefaultAudio() {
      const file = await httpClient.loadDefaultAudio();
      if (file) {
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);
        audioFileInput.files = dataTransfer.files;
        asrBtn.disabled = false;
        asrStatus.textContent = 'File input.wav loaded automatically';
      }
    }

    // Initialize the application
    document.addEventListener('DOMContentLoaded', function() {
      loadDefaultAudio();
    });
  </script>
</body>
</html>